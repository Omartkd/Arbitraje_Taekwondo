<script src="/socket.io/socket.io.js"></script>
<script>
  // Configuración de conexión Socket.IO para producción
  const socket = io({
    transports: ['websocket'],
    upgrade: false,
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 1000,
    timeout: 20000,
    query: {
      clientType: 'scoreboard'
    }
  });

  // Manejo de eventos de conexión
  socket.on('connect', () => {
    console.log('Conectado al servidor de arbitraje');
    document.querySelectorAll('.puntuacion-btn').forEach(btn => {
      btn.disabled = false;
    });
  });

  socket.on('disconnect', (reason) => {
    console.log('Desconectado del servidor:', reason);
    if (reason === 'io server disconnect') {
      socket.connect();
    }
  });

  socket.on('connect_error', (error) => {
    console.error('Error de conexión:', error.message);
    setTimeout(() => socket.connect(), 5000);
  });

  // Mapeo de botones corregido (IDs exactos)
  const buttons = {
    blueHeadKick: document.getElementById('blueHeadKickButton'),
    redHeadKick: document.getElementById('redHeadKickButton'),
    blueBodyKick: document.getElementById('blueBodyKickButton'), // Corregido de bluebodykickButton
    redBodyKick: document.getElementById('redBodyKickButton'),   // Corregido de redbodykickButton
    blueSpinningBodyKick: document.getElementById('blueSpinningBodyKickButton'), // Corregido
    redSpinningBodyKick: document.getElementById('redSpinningBodyKickButton'),   // Corregido
    blueSpinningHeadKick: document.getElementById('blueSpinningHeadKickButton'),
    redSpinningHeadKick: document.getElementById('redSpinningHeadKickButton'),
    bluePunch: document.getElementById('bluePunchButton'),
    redPunch: document.getElementById('redPunchButton'),
    blueSubtract: document.getElementById('blueSubtractButton'),
    redSubtract: document.getElementById('redSubtractButton'),
    blueAdd: document.getElementById('blueAddButton'),
    redAdd: document.getElementById('redAddButton'),
    blueKamgeon: document.getElementById('blueKamgeonButton'),
    redKamgeon: document.getElementById('redKamgeonButton')
  };

  // Asignación de eventos mejorada
  const setupButton = (button, eventName, team) => {
    if (!button) {
      console.error(`Botón no encontrado para ${eventName} (${team})`);
      return;
    }
    button.addEventListener('click', () => {
      socket.emit(eventName, { 
        equipo: team, 
        timestamp: Date.now() 
      });
    });
    button.classList.add('puntuacion-btn');
  };

  // Configuración de todos los botones
  setupButton(buttons.blueHeadKick, 'puntuacionCabeza', 'azul');
  setupButton(buttons.redHeadKick, 'puntuacionCabeza', 'rojo');
  setupButton(buttons.blueBodyKick, 'puntuacionPeto', 'azul');
  setupButton(buttons.redBodyKick, 'puntuacionPeto', 'rojo');
  setupButton(buttons.blueSpinningBodyKick, 'puntuacionGiroPeto', 'azul');
  setupButton(buttons.redSpinningBodyKick, 'puntuacionGiroPeto', 'rojo');
  setupButton(buttons.blueSpinningHeadKick, 'puntuacionGiroCabeza', 'azul');
  setupButton(buttons.redSpinningHeadKick, 'puntuacionGiroCabeza', 'rojo');
  setupButton(buttons.bluePunch, 'puntuacionPuño', 'azul');
  setupButton(buttons.redPunch, 'puntuacionPuño', 'rojo');
  setupButton(buttons.blueSubtract, 'puntuacionRestar', 'azul');
  setupButton(buttons.redSubtract, 'puntuacionRestar', 'rojo');
  setupButton(buttons.blueAdd, 'puntuacionSumar', 'azul');
  setupButton(buttons.redAdd, 'puntuacionSumar', 'rojo');
  setupButton(buttons.blueKamgeon, 'puntuacionKamgeon', 'azul');
  setupButton(buttons.redKamgeon, 'puntuacionKamgeon', 'rojo');

  // Manejo de actualizaciones del servidor
  socket.on('actualizarPuntaje', (data) => {
    if (data && data.blueScore !== undefined && data.redScore !== undefined) {
      document.getElementById('blueScore').textContent = data.blueScore;
      document.getElementById('redScore').textContent = data.redScore;
    } else {
      console.error('Datos de puntuación inválidos:', data);
    }
  });

  socket.on('actualizarKamgeon', (data) => {
    if (data && data.blueKamgeon !== undefined && data.redKamgeon !== undefined) {
      document.getElementById('kamgeon-blue-score').textContent = data.blueKamgeon;
      document.getElementById('kamgeon-red-score').textContent = data.redKamgeon;
    }
  });

  socket.on('victoriaPorDiferencia', (data) => {
    if (!data) return;
    
    const winnerName = data.winner === 'azul' ? 'AZUL' : 'ROJO';
    const message = `¡EQUIPO ${winnerName} GANA POR DIFERENCIA DE 12 PUNTOS!\n\nPuntuación final:\nAzul: ${data.blueScore}\nRojo: ${data.redScore}`;
    
    // Modal mejorado en lugar de alert
    const modal = document.createElement('div');
    modal.style = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; justify-content: center;
      align-items: center; z-index: 1000; color: white; font-size: 2em;
      flex-direction: column; text-align: center;
    `;
    modal.innerHTML = `
      <div style="background: #333; padding: 2em; border-radius: 10px;">
        <h2>${winnerName} GANA!</h2>
        <p>Diferencia: ${data.difference} puntos</p>
        <p>Azul: ${data.blueScore} - Rojo: ${data.redScore}</p>
        <button onclick="this.parentNode.parentNode.remove()" 
          style="padding: 10px 20px; margin-top: 20px; font-size: 1rem;">
          Cerrar
        </button>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Deshabilitar botones
    document.querySelectorAll('.puntuacion-btn').forEach(btn => {
      btn.disabled = true;
    });
  });

  socket.on('gameReset', () => {
    document.querySelectorAll('.puntuacion-btn').forEach(btn => {
      btn.disabled = false;
    });
  });
</script>
